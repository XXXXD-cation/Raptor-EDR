# 构建端点可见性：面向Windows和Linux的EDR遥测数据采集综合设计

## 第一部分：引言 - 高保真EDR遥测的基本原则

在当今复杂且不断演变的威胁环境中，端点检测与响应（EDR）已成为任何成熟安全体系不可或缺的组成部分。EDR技术的核心使命是持续监控端点以发现威胁证据，并执行自动化操作以协助缓解这些威胁。它超越了传统防病毒软件基于签名的静态防护模式，专注于检测那些成功绕过预防性控制的复杂攻击，例如无文件攻击、利用合法系统工具的"就地取材"（Living-off-the-Land）技术以及高级持续性威胁（APT）。

### 现代EDR的定义

现代EDR解决方案不仅仅是一个日志记录工具；它是一个集成了持续监控、数据分析和自动化响应能力的完整安全平台。其根本目标是在攻击者能够横向移动并对整个网络造成重大损害之前，为安全团队提供深入的端点活动可见性。这涉及到在所有受管端点上部署轻量级代理，这些代理不知疲倦地记录关键行为，并将这些遥测数据发送到中央平台进行分析。通过应用人工智能（AI）、机器学习（ML）和全球威胁情报，EDR能够识别出预示着攻击的微妙模式，即所谓的攻击指标（IOA）和失陷指标（IOC）。

这种架构的出现并非偶然，而是安全领域攻防博弈不断升级的直接结果。早期的端点工具依赖于已知的恶意软件签名，但攻击者迅速演变，开始使用无已知签名特征的技术。为了应对这一挑战，安全行业必须转向收集原始的行为数据。从数千个端点收集行为数据会产生海量的遥测信息。实时处理这些数据以发现微小的恶意模式，需要一个专门的大数据分析平台的基础设施和技术，包括数据聚合、关联分析和机器学习。因此，构建现代EDR的核心挑战，既是一个安全问题，也是一个数据工程问题。

### 核心循环：采集、分析、响应

EDR的运作遵循一个持续的闭环流程，该流程构成了其功能的核心：

1.  **持续数据采集**：通过部署在每个端点（如笔记本电脑、服务器和移动设备）上的软件代理，EDR解决方案能够全天候记录相关的端点活动。
2.  **数据聚合与关联**：从各个端点收集的遥测数据被发送到一个集中的数据平台（可以是云端或本地部署），在这里进行聚合、规范化和关联分析。
3.  **行为分析与威胁情报**：平台利用先进的分析引擎，结合AI/ML算法和最新的威胁情报，对聚合数据进行深入分析，以检测与已知攻击策略、技术和程序（TTP）相匹配的可疑行为序列。
4.  **自动化与人工响应**：一旦检测到潜在威胁，EDR系统会生成高优先级警报，并能够触发自动化响应动作，如隔离受感染的端点、终止恶意进程或隔离可疑文件。同时，它也为安全分析师提供丰富的上下文数据以支持人工调查。
5.  **取证数据存储**：EDR保留了详细的历史事件记录，这对于事后取证分析、主动威胁狩猎以及理解长期潜伏的攻击全貌至关重要。

### 上下文的重要性：从孤立事件到攻击叙事

EDR的真正价值在于其构建上下文的能力。单个孤立的事件——例如一个进程的创建——本身可能毫无意义。然而，当EDR将一系列看似无关的事件串联起来时，攻击的全貌便开始浮现：一个进程被创建，紧接着它建立了一个到未知域名的网络连接，随后修改了一个关键的系统文件。这种将遥测数据转化为连贯的"攻击链"或"攻击叙事"的能力，是区分高级EDR解决方案与简单日志聚合工具的关键。正是这种丰富的上下文，赋予了自动化检测规则高保真度，并使安全分析师能够快速理解攻击的范围和影响，从而做出有效的响应。

然而，这种对深度可见性的追求也带来了固有的架构性挑战。EDR代理必须收集"海量数据"以提供"粒度级可见性"，但它运行在生产环境的端点上，性能至关重要。每一个用于数据采集的钩子或探针都会引入微小的性能开销。当这些开销在繁忙的服务器上以每秒数千个事件的频率累积时，就可能对业务应用产生显著影响。这为任何EDR的设计带来了根本性的矛盾：如何在不显著降低系统性能的前提下，收集最丰富的遥测数据。这一矛盾驱动了关键的架构决策，例如选择内核模式还是用户模式代理、在Linux上采用eBPF等高效技术，以及对智能过滤策略的迫切需求，以避免采集价值低、容量大的"噪音"数据。整个EDR数据采集的设计，正是在可见性与性能这两个对立力量之间寻求平衡的一系列权衡。

## 第二部分：全面的数据采集框架 - 与MITRE ATT&CK®对齐

为了系统性地设计EDR所需采集的数据，我们必须采用一个以威胁为导向的框架。MITRE ATT&CK®（对抗性战术、技术和通用知识）框架为此提供了理想的蓝图。它是一个基于全球真实攻击事件观察而构建的知识库，已经成为网络安全领域的通用语言和事实标准。

### MITRE ATT&CK®框架简介

ATT&CK®框架将攻击者的行为分解为一系列的战术（Tactics）、技术（Techniques）和程序（Procedures），即TTPs。

*   **战术**：代表攻击者的战术目标，即"为什么"要执行某个动作。例如，"持久化"（Persistence）、"权限提升"（Privilege Escalation）和"横向移动"（Lateral Movement）。
*   **技术**：描述攻击者为实现战术目标所采用的具体方法，即"如何"执行动作。例如，在"持久化"战术下，一个具体的技术是"创建计划任务/作业"（T1053）。
*   **程序**：指代技术的具体实现方式，即特定攻击团伙或恶意软件使用的工具和步骤。

### 为何ATT&CK®对EDR设计至关重要

将ATT&CK®框架作为EDR遥测数据设计的核心，具有多方面的战略优势：

1.  **提供通用分类法**：ATT&CK®为描述攻击行为提供了一套标准化的词汇，这对于编写检测规则、共享威胁情报和生成报告至关重要，确保了行业内的沟通清晰一致。
2.  **驱动数据源识别**：ATT&CK®矩阵中的每一项技术都明确列出了检测该技术所需的数据源。这为EDR需要采集哪些数据提供了直接的、基于证据的路线图。例如，要检测技术T1059（命令和脚本解释器），所需的数据源是"进程创建"和"命令行参数"。
3.  **实现防御差距分析**：通过将EDR采集的数据源与ATT&CK®矩阵进行映射，组织可以清晰地识别出他们对哪些技术具备可见性，而对哪些技术存在盲点，从而能够有针对性地优先改进其防御能力。
4.  **聚焦于行为而非指标**：ATT&CK®推动了安全监控从追逐静态的失陷指标（IOCs，如文件哈希或IP地址，这些很容易被攻击者更换）转向检测更持久的行为模式（TTPs，如转储LSASS内存的行为本身）。这种基于行为的检测对攻击者来说更难规避。

ATT&CK®框架不仅是一个技术指南，它已经成为塑造网络安全市场格局的强大力量。EDR供应商现在普遍根据其ATT&CK®覆盖率进行评估和比较。MITRE Engenuity进行的公开评估，通过模拟基于ATT&CK®的真实攻击活动来测试供应商的能力，为市场提供了一个数据驱动的、公开的基准。这直接影响了EDR产品的研发路线图：一旦ATT&CK®中出现新的重要技术，供应商就会面临巨大的市场压力，必须为其开发相应的遥测和检测能力，使得该框架成为EDR能力的行业标准。

这种行业性的转变也直接催生了对更丰富、更具上下文的数据的需求。在ATT&CK®出现之前，简单地记录"进程已创建"可能被认为是足够的。然而，ATT&CK®技术T1059.001（PowerShell）清楚地表明，仅仅知道powershell.exe运行了是毫无价值的；其检测价值在于命令行参数，如-enc、-nop、-w hidden。同样，技术T1003.001（LSASS内存）不仅需要知道一个进程访问了另一个进程，还需要具体知道是哪个进程（如rundll32.exe）以特定的访问权限访问了lsass.exe。因此，为了实现有意义的ATT&CK®覆盖，EDR不能只收集表层事件，它必须采集深度、上下文丰富的数据：完整的命令行、父子进程关系、跨进程内存访问权限、加载的动态链接库等等。这种向行为检测模型的转变，正是本报告所详述的全面数据采集需求的根本驱动力。

## 第三部分：核心遥测类别 - 端点可见性的基础支柱

本部分将详细阐述EDR必须采集的各类核心遥测数据。这些数据类别共同构成了端点可见性的基础，使得安全系统能够重建攻击链并识别恶意活动。

### 3.1 进程与命令行活动

进程监控是EDR无可争议的基石。几乎所有的攻击者活动都涉及代码执行，这使得进程活动成为最关键的遥测数据源。

#### 需采集的数据点

*   **进程创建**：新进程启动的事件。
*   **进程终止**：进程结束的事件。
*   **完整镜像路径**：可执行文件的完整路径（例如，C:\Windows\System32\svchost.exe）。
*   **进程ID (PID) 和进程GUID**：操作系统分配的PID以及一个全局唯一标识符，以解决PID重用问题。
*   **完整命令行**：用于启动进程的精确命令及其所有参数。这一点至关重要。
*   **父进程信息**：创建新进程的父进程的镜像路径、PID、GUID和命令行。这对于建立执行链至关重要。
*   **用户上下文**：发起进程的用户账户（在Windows上包括其SID）。
*   **完整性级别 (Windows)**：进程令牌的完整性级别（例如，低、中、高、系统）。
*   **哈希值**：可执行文件的加密哈希值（MD5, SHA1, SHA256, IMPHASH）。
*   **时间戳**：精确的进程创建和终止的UTC时间戳。

#### Windows采集策略

*   **原生日志（基线）**：Windows安全事件ID 4688（"已创建一个新进程"）。
    *   **局限性**：默认情况下，此事件不记录命令行，这极大地限制了其可用性。
    *   **增强**：必须通过组策略（"在进程创建事件中加入命令行"）启用，才能发挥作用。但它仍然缺少进程GUID和哈希值等关键信息。
*   **高级检测（推荐）**：Sysmon事件ID 1（"Process creation"）。
    *   **优势**：开箱即用地提供了极为丰富的数据集，包括上述所有数据点：进程GUID、父进程GUID、哈希值、父进程命令行等。这使其成为Windows上进程监控的黄金标准。

#### Linux采集策略

*   **原生日志（传统）**：auditd框架。
    *   **机制**：配置auditd规则以监控execve和execveat系统调用。这能捕获每一次程序执行。
    *   **捕获数据**：提供可执行文件路径、命令行参数、用户ID（UID/AUID）和进程ID（PID）。
    *   **缺点**：在繁忙的系统上可能会产生显著的性能开销，并且其日志格式复杂，为多行格式，需要仔细解析。
*   **高级检测（现代/推荐）**：eBPF (扩展的伯克利数据包过滤器)。
    *   **机制**：将eBPF程序附加到与进程执行相关的内核跟踪点或kprobes上（例如，sched_process_exec）。
    *   **优势**：eBPF的性能远超auditd，因为它可以在内核空间内进行数据过滤和聚合，从而减少了发送到用户空间的数据量。它允许以更低的开销收集高度定制化和丰富的遥测数据，是现代Linux EDR的首选方法。

攻击者广泛使用"就地取材"二进制文件（LOLBins）——即合法的、有签名的Windows可执行文件，如powershell.exe、rundll32.exe和wmic.exe。一个仅仅因为powershell.exe运行就报警的检测规则将产生无法忍受的噪音。恶意意图并非由进程名揭示，而是由其参数揭示：例如powershell.exe -enc JABBA...（编码的命令）。因此，收集完整、未经篡改的命令行不是一个可选项，而是任何EDR要有效对抗现代TTPs的一个基本、不可协商的要求。缺少这个数据点将使EDR对ATT&CK®矩阵中的大量技术束手无策。

此外，操作系统会积极地重用进程ID（PID）。在繁忙的服务器上，一个PID可能在几秒钟内就被回收。这会导致调查人员在分析日志时将不同时间点的事件错误地归因于同一个PID，从而破坏取证分析的时间线。Sysmon引入的ProcessGuid 解决了这个关键缺陷。

ProcessGuid是一个在进程实例的整个生命周期内持续存在且永不重用的唯一标识符。它允许EDR明确地将所有事件（进程创建、网络连接、文件写入等）与执行这些操作的确切进程实例联系起来，创建一条可靠且不可破坏的审计轨迹。这是实现精确的自动化关联和攻击链重建的深层要求。

**表 3.1：进程活动遥测数据**

| 数据字段 | 描述与安全价值 | Windows采集方法 | Linux采集方法 | 相关MITRE ATT&CK®战术 |
| :--- | :--- | :--- | :--- | :--- |
| 进程路径 | 可执行文件的完整路径。识别已知恶意软件或位于异常路径的合法工具。 | Sysmon EID 1, Event ID 4688 | auditd (execve), eBPF | 执行, 持久化 |
| 完整命令行 | 启动进程的确切命令和参数。检测LOLBins滥用、无文件攻击和恶意脚本。 | Sysmon EID 1, Event ID 4688 (需GPO启用) | auditd (execve), eBPF | 执行, 防御规避 |
| 进程ID (PID) | 操作系统分配的标识符。用于短期内的事件关联。 | Sysmon EID 1, Event ID 4688 | auditd (execve), eBPF | - |
| 进程GUID | 全局唯一标识符。解决PID重用问题，确保长期、准确的事件关联。 | Sysmon EID 1 | eBPF (可实现) | - |
| 父进程信息 | 创建当前进程的父进程的路径、命令行和ID。构建进程链，识别异常父子关系（如Word创建PowerShell）。 | Sysmon EID 1, Event ID 4688 | auditd (execve), eBPF | 执行, 防御规避, 权限提升 |
| 用户上下文 | 执行进程的用户账户（UID/SID）。识别在非预期用户（如服务账户）下运行的进程。 | Sysmon EID 1, Event ID 4688 | auditd (execve), eBPF | 权限提升, 横向移动 |
| 哈希值 | 可执行文件的加密哈希（SHA256/IMPHASH）。用于威胁情报匹配和识别被篡改的文件。 | Sysmon EID 1 | eBPF (可实现) | 执行, 持久化 |
| 完整性级别 | (Windows) 进程的安全上下文。检测UAC绕过和权限提升。 | Sysmon EID 1 | 不适用 | 权限提升, 防御规避 |

### 3.2 文件系统操作

监控文件的创建、修改和删除对于检测恶意软件植入、数据篡改、勒索软件加密以及攻击者清理痕迹等活动至关重要。

#### 需采集的数据点

*   **文件创建**：新文件写入磁盘的事件。
*   **文件删除**：文件被删除的事件。
*   **文件修改/写入**：文件内容被更改的事件。
*   **文件重命名**：文件被重命名的事件。
*   **目标文件完整路径**：被操作文件的完整路径。
*   **进程信息**：执行文件操作的进程（镜像路径、PID/GUID、命令行）。
*   **用户上下文**：发起操作的用户。
*   **哈希值**：文件创建时其内容的哈希值。
*   **权限变更**：文件的访问控制列表（ACL）或权限（如chmod）被修改的事件，包括新旧权限。

#### Windows采集策略

*   **原生日志（基线）**：
    *   **文件审计**：需要通过GPO启用"审核对象访问"，然后对特定文件/文件夹应用系统访问控制列表（SACL）。这会生成事件ID 4663（访问）、4660（删除）和4656（请求句柄）。这种方法配置复杂且在大规模部署时会产生大量噪音。
    *   **权限变更**：事件ID 4670（"对象的权限已更改"）用于跟踪DACL的变更。需要启用"审核文件系统"子类别。
*   **高级检测（推荐）**：
    *   **Sysmon事件ID 11（"FileCreate"）**：记录新文件的创建，并将创建事件与源进程关键地联系起来。这对于追踪恶意软件释放器至关重要。
    *   **Sysmon事件ID 23（"FileDelete"） / 26（"FileDeleteDetected"）**：记录文件删除。EID 23会存档被删除的文件，而EID 26仅记录事件，提供了一个存储密集度较低的选项。这对于捕获攻击者的清理行为至关重要。
    *   **受控文件夹访问（CFA）**：一项专门用于保护敏感目录免受未经授权修改的功能，会生成事件1123（阻止）和1124（审核）。

#### Linux采集策略

*   **原生日志（传统）**：
    *   **auditd**：最强大的原生工具。可以通过两种方式配置：
        *   **监视（Watches）**：使用`-w /path/to/dir -p rwax`来监视特定文件或目录的读、写、执行或属性更改。
        *   **系统调用审计**：直接监控与文件相关的系统调用，如`open`、`openat`、`creat`、`unlink`、`rename`、`chmod`、`fchmod`、`chown`、`fchown`。这种方法更全面，但可能产生更多日志。
*   **替代检测**：
    *   **inotify**：一个内核子系统，允许应用程序监控文件系统事件。
        *   **局限性**：存在一些限制，如可能发生队列溢出、无法识别引发变更的用户/进程，以及在大规模递归监控方面的困难。通常不适合作为强大的EDR代理的独立解决方案，但可用于有针对性的监控。
*   **高级检测（现代/推荐）**：
    *   **eBPF**：将eBPF程序附加到虚拟文件系统（VFS）层函数或相关的系统调用。这提供了与auditd相同的可见性，但在内核内过滤方面具有更高的性能和灵活性。

无论是Windows的原生文件审计（SACLs）还是Linux的auditd系统调用审计，都因其极高的"噪音"而著称，正常系统操作会产生海量事件。一个安全团队可能希望监控对`C:\Windows\System32`的写入操作，但启用原生审计后，每分钟都会收到来自Windows更新、日志服务等合法进程的数千个事件。这种数据洪流会淹没SIEM系统，产生巨大的存储成本，并使分析师无法找到那一个真正的恶意事件。这种操作现实是推动采用更智能工具的主要原因。Sysmon允许在其配置中进行强大的、有针对性的过滤，让您在事件生成之前就排除已知的良性进程。Linux上的eBPF更进一步，允许复杂的过滤逻辑直接在内核中运行，这是丢弃噪音最有效的地方。因此，有效的文件系统监控，关键不在于记录什么，而在于不记录什么。从原始审计到像Sysmon和eBPF这样具备过滤和上下文感知能力的工具的演进，正是这个"信噪比"问题的直接结果。

此外，虽然文件的创建和修改很常见，但有针对性的文件删除是恶意活动的一个更强烈的信号，特别是与清理和防御规避相关的活动。攻击者下载工具或暂存数据到临时文件中，使用后会删除它们以掩盖踪迹并阻碍取证分析。良性应用程序很少会删除可执行文件或关键日志文件。因此，监控敏感位置（如`C:\Users\*\Downloads`、`/tmp`、`/var/log`）的文件删除操作，可以提供高保真度的警报。Sysmon为删除操作提供了两个独立的事件ID（23和26），这一事实凸显了该数据源的重要性。在存档（保留恶意软件样本）和仅记录（节省存储空间）之间的选择，反映了在取证完整性和运营成本之间的权衡。

**表 3.2：文件系统操作遥测数据**

| 数据字段 | 描述与安全价值 | Windows采集方法 | Linux采集方法 | 相关MITRE ATT&CK®战术 |
| :--- | :--- | :--- | :--- | :--- |
| 文件创建 | 新文件写入磁盘。检测恶意软件释放、数据暂存。 | Sysmon EID 11, Native Auditing (4663) | auditd (syscall/watch), eBPF, inotify | 执行, 影响 |
| 文件写入/修改 | 文件内容被更改。检测勒索软件加密、配置文件篡改。 | Native Auditing (4663) | auditd (syscall/watch), eBPF, inotify | 影响, 持久化 |
| 文件删除 | 文件被删除。检测攻击者清理痕迹、反取证行为。 | Sysmon EID 23/26, Native Auditing (4660) | auditd (syscall/watch), eBPF, inotify | 防御规避 |
| 文件重命名 | 文件名被更改。检测恶意软件伪装、篡改日志文件。 | Native Auditing (4663) | auditd (syscall/watch), eBPF, inotify | 防御规避 |
| 权限变更 | 文件DACL或权限模式被修改。检测权限提升、锁定合法用户访问。 | Event ID 4670 | auditd (syscall/watch), eBPF | 防御规避, 权限提升 |
| 所有权变更 | 文件所有者被更改。检测权限提升、获取对受保护文件的控制权。 | Event ID 4670 | auditd (syscall/watch), eBPF | 权限提升 |
| 目标文件路径 | 被操作文件的完整路径。提供操作发生的具体位置上下文。 | 所有方法 | 所有方法 | - |
| 执行进程信息 | 执行文件操作的进程。将文件活动归因于特定程序，识别恶意来源。 | 所有方法 | auditd, eBPF | - |

### 3.3 网络通信与DNS

追踪网络活动对于检测命令与控制（C2）通信、横向移动和数据外泄至关重要。

#### 需采集的数据点

*   **连接事件**：入站/出站TCP/UDP连接的发起。
*   **进程信息**：发起或接收连接的进程（镜像路径、PID/GUID、命令行）。这是最关键的上下文信息。
*   **用户上下文**：建立连接时所使用的用户账户。
*   **网络详情**：源IP、源端口、目标IP、目标端口、协议（TCP/UDP）。
*   **方向**：入站或出站。
*   **DNS查询**：被查询的域名。
*   **DNS响应**：响应中返回的IP地址。
*   **DNS查询状态**：成功或失败代码。

#### Windows采集策略

*   **原生日志（基线）**：
    *   **Windows筛选平台（WFP）**：Windows防火墙的底层技术。可配置为通过"审核筛选平台连接"策略记录允许/拒绝的连接，生成事件ID 5156（允许）和5157（阻止）。提供网络详情，但日志量可能很大，且需要关联才能链接回进程。
    *   **DNS客户端日志**："Microsoft-Windows-DNS-Client/Operational"日志可以被启用以记录DNS查询（事件ID 3010）和响应（事件ID 3020）。DNS服务器角色有更详细的分析日志（事件ID 256、257）。
*   **高级检测（推荐）**：
    *   **Sysmon事件ID 3（"Network connection"）**：黄金标准。直接将网络连接（TCP/UDP）与创建它的进程（包括其完整镜像路径和其他元数据）关联起来。由于其即时的进程上下文，对于EDR而言远优于WFP日志。
    *   **Sysmon事件ID 22（"Dns query"）**：记录DNS查询及其结果，并将其直接与负责的进程关联。这一点至关重要，因为它即使在后续网络连接到CDN或轮换IP地址的情况下，也能揭示C2域名。

#### Linux采集策略

*   **原生日志（传统）**：
    *   **auditd**：配置规则以监控`connect`、`accept`和`bind`系统调用。这提供了关于哪个进程发起了连接以及连接到哪个地址/端口的信息。与其他auditd数据源一样，日志量可能很大。
    *   **DNS日志**：高度依赖于所使用的DNS服务器软件（如BIND、dnsmasq、Unbound等）。配置通常涉及在特定守护进程的配置文件中启用查询日志记录，然后将日志记录到syslog或专用文件中。这是服务器端的日志，会遗漏那些直接查询外部解析器的客户端查询。
*   **高级检测（现代/推荐）**：
    *   **eBPF**：这是Linux上网络监控的理想技术。eBPF程序可以附加到内核网络函数（如`tcp_connect`）或流量控制（tc）子系统，以最小的性能影响监控所有网络流量。它可以高效地捕获进程上下文、网络元组，甚至在需要时捕获载荷数据。

正如命令行参数揭示了进程的意图一样，DNS查询也揭示了网络连接的意图。攻击者需要与他们的C2服务器通信，但硬编码IP地址的方式很脆弱，因为IP可以被阻止或更改。他们使用域名（例如，evil-c2.badguy.com）来保持灵活性。因此，受感染机器在建立C2通道之前采取的第一个动作通常是为C2域名执行DNS查询。这个DNS查询本身就是一个高保真度的、早期的失陷指标。像域名生成算法（DGA）这样的技术会产生高度随机、不可读的域名，这些域名在DNS日志中非常显眼。因此，收集与进程关联的DNS查询（通过Sysmon EID 22或eBPF）可以说比收集后续基于IP的连接日志更为重要。域名比短暂的IP地址更能清晰地揭示攻击者的基础设施和意图。

此外，EDR解决方案本身也成为了攻击者的网络目标。像EDRSilencer 这类工具的存在和流行揭示了一个深层问题：攻击者不仅试图规避EDR的检测，他们还积极地通过攻击其网络通信来瘫痪EDR的遥测能力。EDR代理收集数据并将其发送到云端或本地管理控制台进行分析，这个过程本身就是一个网络连接。拥有管理员权限的攻击者可以利用操作系统原生功能（如Windows筛选平台WFP）来创建防火墙规则。EDRSilencer等工具自动化了识别EDR代理进程（如sentinel.exe、csfalcon.exe）并创建WFP规则以阻止其所有出站流量的过程。结果就是一个"失明"的EDR。代理可能仍在本地运行，但无法报告其发现，导致安全团队对正在进行的攻击一无所知。这意味着一个强大的EDR解决方案必须具备自我保护机制，需要监控对其自身进程和通信渠道的篡改行为。这包括审计WFP中针对其自身可执行文件的规则，这是一种对其弹性至关重要的"元遥测"。

**表 3.3：网络与DNS遥测数据**

| 数据字段 | 描述与安全价值 | Windows采集方法 | Linux采集方法 | 相关MITRE ATT&CK®战术 |
| :--- | :--- | :--- | :--- | :--- |
| 出站连接 | 进程发起的TCP/UDP连接。检测C2通信、恶意软件下载、数据外泄。 | Sysmon EID 3, WFP (EID 5156) | auditd (connect), eBPF | 命令与控制, 影响 |
| 入站连接 | 进程接收的TCP/UDP连接。检测远程访问工具、反向Shell。 | Sysmon EID 3, WFP (EID 5156) | auditd (accept), eBPF | 命令与控制, 横向移动 |
| 源/目标IP与端口 | 连接的四元组信息。识别与已知恶意IP的通信。 | 所有方法 | 所有方法 | 命令与控制 |
| 执行进程信息 | 发起或接收连接的进程。将网络活动归因于特定程序，识别后门。 | Sysmon EID 3 | auditd, eBPF | 命令与控制, 执行 |
| DNS查询 | 进程解析的域名。识别C2域名、DGA算法、DNS隧道。 | Sysmon EID 22, DNS Client/Server Logs | eBPF, DNS Server Logs | 命令与控制 |
| DNS响应 | 查询返回的IP地址。识别恶意IP、DNS劫持。 | Sysmon EID 22, DNS Client/Server Logs | eBPF, DNS Server Logs | 命令与控制 |
| DNS查询状态 | 查询成功或失败。异常的失败模式可能预示着网络问题或特定攻击。 | Sysmon EID 22, DNS Client/Server Logs | eBPF, DNS Server Logs | - |

### 3.4 身份验证与身份管理

监控登录活动以及用户和组的变更，是检测凭证盗窃、权限提升和横向移动的基础。

#### 需采集的数据点

*   **成功登录**：用户成功通过身份验证的事件。
*   **登录失败**：身份验证尝试失败的事件。
*   **登录类型**：用户登录的方式（例如，交互式、网络、远程交互式、服务）。
*   **账户信息**：用户账户名、域名和SID（Windows）或UID/GID（Linux）。
*   **源信息**：登录源头的工作站名称和IP地址。
*   **用户/组管理**：用户/组的创建、删除和修改事件。
*   **权限提升**：与UAC绕过（Windows）或sudo执行（Linux）相关的事件。

#### Windows采集策略

*   **原生日志（必需）**：
    *   **事件ID 4624（"一个帐户已成功登录"）**：追踪成功访问的主要事件。登录类型字段对于提供上下文至关重要。
    *   **事件ID 4625（"一个帐户登录失败"）**：追踪失败的尝试。对于检测暴力破解或密码喷洒攻击至关重要。状态/子状态码提供了失败的原因。
    *   **账户管理事件**：一系列事件追踪用户和组的生命周期。关键ID包括4720（用户已创建）、4722（用户已启用）、4725（用户已禁用）、4726（用户已删除）、4738（用户已更改），以及相应的组事件（例如，4728/4732 - 成员已添加到组）。
    *   **UAC事件**：虽然没有单一的"UAC成功"事件，但结合进程创建事件中完整性级别的变化（从中到高）和进程继承关系（例如，fodhelper.exe派生cmd.exe），可以指示UAC绕过。

#### Linux采集策略

*   **原生日志（必需）**：
    *   **PAM日志**：可插拔身份验证模块（PAM）框架处理身份验证。日志通常写入`/var/log/auth.log`（Debian/Ubuntu）或`/var/log/secure`（RHEL/CentOS），包含通过SSH、su、sudo等方式成功和失败登录的详细信息。
    *   **登录记录**：`wtmp`和`btmp`文件分别记录成功和失败的登录会话。可以使用`last`和`lastb`命令查询这些文件。
    *   **auditd**：创建规则以监控用户和组管理二进制文件的执行（`useradd`、`usermod`、`userdel`、`groupadd`等）。同时，审计对关键文件如`/etc/passwd`、`/etc/shadow`和`/etc/group`的写入操作。
    *   **sudo的使用**可以通过其自身配置进行日志记录，也可以通过审计sudo进程的execve系统调用来捕获。

Windows事件4624/4625中的"登录类型"字段不仅仅是一个分类，它还是行为分析和异常检测的关键数据点。标准工作站用户主要产生登录类型2（交互式），文件服务器主要看到来自访问共享用户的登录类型3（网络），而管理员使用远程桌面管理服务器则产生登录类型10（远程交互式）。这些模式是稳定的，构成了每个用户和机器类型的行为基线。横向移动的攻击者会打破这些基线。例如，一个受感染的工作站账户突然向关键服务器产生一个登录类型10的事件，这是一个巨大的异常。一个本应只产生登录类型5的服务账户突然产生一个登录类型2的事件，也是如此。这意味着，一个有效的EDR不仅要收集登录事件，还必须主动地对每个用户/主机的登录类型进行画像和基线分析，以检测横向移动的微妙迹象。

此外，单个用户操作通常会在多个、不相连的系统上生成日志，这需要复杂的关联分析。例如，一个用户在WorkstationA上访问ServerB上的文件共享。WorkstationA会记录一个Kerberos身份验证事件，域控制器会记录Kerberos票据授予事件，而ServerB会记录成功的网络登录事件（事件ID 4624，登录类型3）。这一个逻辑操作在三台不同的机器上产生了三个独立的日志条目。连接它们的唯一方法是通过关联用户账户名、源IP和时间戳等字段。在Windows中，事件4624中的Logon ID对于将服务器上的后续操作与特定的登录会话关联起来至关重要。这意味着EDR不能仅仅是一个以端点为中心的解决方案。为了有效地追踪身份和横向移动，它必须不仅从端点，还要从域控制器（或其等效物）中摄取和关联数据，以构建一个完整的"身份链"。这是从EDR向扩展检测与响应（XDR）演进的关键驱动力之一。

**表 3.4：身份验证与身份遥测数据**

| 数据字段 | 描述与安全价值 | Windows采集方法 | Linux采集方法 | 相关MITRE ATT&CK®战术 |
| :--- | :--- | :--- | :--- | :--- |
| 成功登录 | 用户成功通过身份验证。监控异常时间、地点或账户的登录。 | Event ID 4624 | PAM logs (/var/log/auth.log, /var/log/secure), wtmp | 初始访问, 横向移动 |
| 登录失败 | 用户身份验证失败。检测暴力破解、密码喷洒攻击。 | Event ID 4625 | PAM logs, btmp | 凭证访问 |
| 登录类型 | 登录方式（交互式、网络等）。识别异常行为模式，如服务账户进行交互式登录。 | Event ID 4624/4625 | PAM logs (service name) | 横向移动, 权限提升 |
| 用户/组创建 | 新用户或组被创建。检测攻击者创建后门账户。 | Event ID 4720 (User), 4727/4731/4754 (Group) | auditd (useradd, groupadd) | 持久化 |
| 用户/组删除 | 用户或组被删除。检测对合法账户的破坏性行为。 | Event ID 4726 (User), 4730/4734/4758 (Group) | auditd (userdel, groupdel) | 影响 |
| 用户/组修改 | 用户或组属性被更改。检测对账户的恶意修改，如密码重置。 | Event ID 4738 (User), 4735/4737/4755 (Group) | auditd (usermod, groupmod) | 持久化, 权限提升 |
| 组成员变更 | 用户被添加或移出组。检测对特权组（如管理员组）的非法添加。 | Event ID 4728/4732/4756 (Add), 4729/4733/4757 (Remove) | auditd (usermod, gpasswd), audit /etc/group | 权限提升 |
| 权限提升 | 用户获得更高权限。检测UAC绕过或滥用sudo。 | Process Creation (Integrity Level Change) | auditd (sudo), sudo logs | 权限提升 |

### 3.5 动态代码、模块与驱动加载

这一类别对于检测无文件攻击、持久化机制以及在操作系统底层运行的威胁（如rootkit）至关重要。

#### 需采集的数据点

*   **镜像/模块加载**：DLL（Windows）或共享对象（.so，Linux）被加载到进程内存中的事件。
*   **模块信息**：加载模块的完整路径、其哈希值和签名信息（例如，是否签名、签名是否有效、签名者名称）。
*   **加载进程**：加载该模块的进程。
*   **驱动加载**：内核模式驱动被加载的事件。
*   **驱动信息**：驱动文件的完整路径、哈希值和签名信息。
*   **脚本执行**：正在执行的脚本（如PowerShell、VBScript）的内容。
*   **API/系统调用监控**：对特定高风险API调用或系统调用的拦截。

#### Windows采集策略

*   **高级检测（必需）**：
    *   **Sysmon事件ID 7（"Image loaded"）**：记录进程加载模块（DLL）的事件。这对于检测DLL劫持、进程注入和像Mimikatz这样的凭证窃取工具（它们会加载特定的DLL）非常有价值。日志量可能很大，因此过滤是关键。
    *   **Sysmon事件ID 6（"Driver loaded"）**：记录驱动程序加载到内核的事件。对于检测rootkit和其他内核模式威胁至关重要。
    *   **PowerShell日志记录（关键）**：
        *   **脚本块日志（事件ID 4104）**：记录PowerShell代码在执行时的完整内容，关键在于它是在去混淆之后记录的。这是挫败基于PowerShell攻击的最重要的数据源。
        *   **模块日志（事件ID 4103）**：记录特定PowerShell模块的管道执行事件，提供额外的上下文。
        *   **反恶意软件扫描接口（AMSI）**：一个接口，允许应用程序（如PowerShell）在执行前将内容传递给已安装的反病毒/EDR产品进行扫描。它为内存中和基于脚本的攻击提供了另一层可见性。

#### Linux采集策略

*   **原生日志（传统）**：
    *   **auditd**：配置规则以监控`init_module`、`finit_module`和`delete_module`系统调用，以跟踪内核模块的加载和卸载。
    *   **共享对象加载**：可以通过监视对`.so`扩展名文件的`open`或`mmap`系统调用来间接监控，但这并不精确。`ldd`命令可以显示依赖关系，但这是静态信息，而非运行时信息。
*   **高级检测（现代/推荐）**：
    *   **eBPF**：将eBPF程序附加到与加载共享库或内核模块相关的内核函数上，以获取精确的、实时的信息，并包含进程上下文，且开销较低。

PowerShell三种不同类型的日志记录（模块、脚本块、转录）并非冗余，而是针对无文件攻击技术演变而构建的分层防御体系。攻击者开始使用PowerShell进行"就地取材"攻击，防御者开始记录基本的PowerShell命令（相当于模块日志）。攻击者则通过深度混淆来应对，使日志记录的命令无法阅读。微软随即推出了脚本块日志（EID 4104），它记录的是代码在引擎执行时的状态，意味着代码是去混淆的，这改变了游戏规则。接着，攻击者又开发出完全绕过日志记录的技术（如降级PowerShell版本）。微软则推出了AMSI，提供了一个通用接口，在执行前扫描内容，无论其使用了何种混淆技术。这清晰地展示了一场不断升级的攻防竞赛。对于EDR而言，这意味着不能仅依赖其中一种数据源，一个全面的解决方案必须能够摄取并关联来自所有这些来源的数据，以抵御不同的规避技术。

此外，在驱动加载（Sysmon EID 6）和模块加载（Sysmon EID 7）事件中，签名信息（Signed, Signature, SignatureStatus）的重要性反复出现。操作系统，特别是Windows，拥有大量来自微软和可信供应商的合法的、有签名的驱动程序和DLL。而恶意软件，特别是rootkit或定制的攻击工具，通常是未签名的，或使用被盗/无效的证书签名。手动分析海量的模块和驱动加载事件是不可能的。然而，通过将签名状态作为主要过滤器，安全团队可以立即将数据集减少99%以上，仅关注风险最高的事件：未签名代码的加载。这揭示了一个关键的EDR检测策略：对环境中所有合法的、有签名的驱动/模块进行基线分析，并对任何偏离基线的行为，特别是加载新的、未签名的代码，进行报警。这是一种强大而高效的威胁狩猎方法。

**表 3.5：动态代码与模块加载遥测数据**

| 数据字段 | 描述与安全价值 | Windows采集方法 | Linux采集方法 | 相关MITRE ATT&CK®战术 |
| :--- | :--- | :--- | :--- | :--- |
| DLL/共享对象加载 | 进程在内存中加载动态链接库。检测DLL劫持、进程注入、凭证窃取工具。 | Sysmon EID 7 | eBPF, auditd (open/mmap) | 防御规避, 权限提升 |
| 驱动/内核模块加载 | 内核加载驱动程序。检测Rootkit、内核级持久化。 | Sysmon EID 6 | auditd (init_module等), eBPF | 防御规避, 持久化 |
| 模块路径 | 被加载模块的完整文件路径。识别从异常位置加载的模块。 | Sysmon EID 6, 7 | auditd, eBPF | 防御规避 |
| 模块哈希值 | 模块文件的加密哈希。用于威胁情报匹配。 | Sysmon EID 6, 7 | eBPF (可实现) | 防御规避 |
| 模块签名状态 | 模块的数字签名信息。检测未签名或签名无效的代码，是高保真度恶意指标。 | Sysmon EID 6, 7 | - | 防御规避, 持久化 |
| 加载进程信息 | 加载模块的进程。将模块加载活动归因于特定程序。 | Sysmon EID 7 | auditd, eBPF | - |
| PowerShell脚本块 | (Windows) 去混淆后的PowerShell代码。检测恶意脚本和无文件攻击的核心。 | PowerShell Script Block Logging (EID 4104) | 不适用 | 执行 |
| AMSI扫描内容 | (Windows) 提交给AMSI扫描的内容和结果。提供对内存中脚本和payload的可见性。 | AMSI ETW Provider | 不适用 | 防御规避, 执行 |

### 3.6 系统完整性与配置变更

监控对持久化系统配置（如注册表、服务和计划任务）的更改，是检测持久化、防御规避和权限提升的关键。

#### 需采集的数据点

*   **注册表修改 (Windows)**：注册表键/值的创建、删除和修改事件。
*   **服务安装/修改**：Windows服务或Linux systemd单元的创建或修改。
*   **计划任务创建/修改**：计划任务（Windows）或cron作业（Linux）的创建或修改。
*   **WMI事件 (Windows)**：WMI事件筛选器、消费者和绑定的创建。
*   **配置文件更改 (Linux)**：对`/etc/`、`/usr/lib/systemd/`等目录中关键文件的修改。

#### Windows采集策略

*   **高级检测（必需）**：
    *   **Sysmon事件ID 12, 13, 14（"RegistryEvent"）**：提供对注册表键和值的创建、删除和设置操作的详细日志。对于追踪通过运行键、服务创建和许多其他TTP实现的持久化至关重要。
    *   **Sysmon事件ID 19, 20, 21（"WmiEvent"）**：追踪WMI持久化机制的创建。
*   **原生日志**：Windows记录服务创建（事件ID 4697）和计划任务创建（事件ID 4698）。

#### Linux采集策略

*   **原生日志（必需）**：
    *   **auditd**：这是主要工具。在关键配置目录如`/etc/`、`/etc/cron.d/`、`/etc/systemd/system/`上使用文件系统监视（`-w`）来监控更改。
    *   **eBPF**：也可用于以更高性能监控对这些关键文件的写入。

攻击者在获得初始访问权限后，其首要目标之一是建立持久化，以确保在系统重启后不会失去访问权限。Windows注册表（如运行键）、服务和计划任务是实现此目的最常见的机制。在Linux上，则是cron作业、systemd服务和shell配置文件。因此，监控这些特定的配置位置不仅仅是常规的"变更控制"，而是直接对抗攻击者中期目标的关键对策。EDR的检测逻辑应重点识别这些持久化位置的异常更改。

许多配置更改不仅仅是静态设置，它们是代码执行的直接手段。例如，创建一个新的Windows服务涉及到写入注册表键，指定一个可执行文件路径。当服务启动时，该可执行文件将以SYSTEM权限运行。同样，创建一个WMI事件消费者可以指定在某个系统事件发生时运行一个脚本或二进制文件。这意味着一个RegSetValue事件或一个WMI对象创建事件不仅仅是一个配置更改，它是一个延迟执行事件。这模糊了遥测类别之间的界限：一次注册表写入可能是未来某个恶意进程执行的根本原因。这意味着一个复杂的EDR必须能够跨时间关联这些事件。它需要能够看到evil.exe在上午10:00的注册表写入，并将其与下午3:00重启后启动的一个可疑的svchost.exe进程（托管新服务）联系起来。这种长期的事件关联是一个重大的技术挑战，也是高级EDR平台的关键区别所在。

**表 3.6：系统完整性与配置遥测数据**

| 数据字段 | 描述与安全价值 | Windows采集方法 | Linux采集方法 | 相关MITRE ATT&CK®战术 |
| :--- | :--- | :--- | :--- | :--- |
| 注册表修改 | (Windows) 注册表键/值的创建、删除、修改。检测持久化（如Run键）、配置篡改、防御规避。 | Sysmon EID 12, 13, 14 | 不适用 | 持久化, 防御规避 |
| 服务创建/修改 | 新服务被创建或现有服务被修改。检测通过服务实现的持久化和权限提升。 | Event ID 4697, Sysmon Registry Events | auditd (watch /etc/systemd/) | 持久化, 权限提升 |
| 计划任务/Cron作业 | 新的计划任务或cron作业被创建/修改。检测通过计划任务实现的持久化。 | Event ID 4698 | auditd (watch /etc/cron.d/等) | 持久化, 执行 |
| WMI持久化 | (Windows) WMI事件筛选器、消费者、绑定的创建。检测高级的、无文件的持久化技术。 | Sysmon EID 19, 20, 21 | 不适用 | 持久化, 执行 |
| 关键配置文件修改 | (Linux) 对`/etc`等目录中文件的修改。检测对系统配置、用户、网络服务的篡改。 | 不适用 | auditd (watch), eBPF | 持久化, 防御规避 |

### 3.7 用于威胁狩猎的高级遥测

此类别涵盖了专门的、通常是高容量的数据源，这些数据源对于主动的、假设驱动的威胁狩猎非常有价值，但可能需要仔细过滤才能广泛部署。

#### 需采集的数据点

*   **跨进程内存访问**：一个进程访问另一个进程的内存。
*   **原始API/系统调用追踪**：进程所做API调用的详细追踪。
*   **集中式命令历史**：每个用户以交互方式键入的每个命令的防篡改日志。

#### Windows采集策略

*   **Sysmon事件ID 10（"ProcessAccess"）**：记录一个进程打开另一个进程的事件，并指定请求的访问权限。其主要用途是检测访问lsass.exe内存的凭证转储工具。
*   **API监控**：EDR代理通常使用用户态API挂钩（例如，修补ntdll.dll）或内核回调来监控对敏感函数的调用，如VirtualAllocEx、WriteProcessMemory和CreateRemoteThread，这些都与进程注入有关。

#### Linux采集策略

*   **集中式Bash历史**：标准的`.bash_history`是每个用户私有的，且容易被篡改。一个强大的解决方案是使用`PROMPT_COMMAND`环境变量或修改`/etc/profile.d/`中的shell配置，将每个执行的命令实时发送到中央、安全的syslog服务器。
*   **系统调用追踪**：像`strace`这样的工具对调试很有用，但不可扩展。auditd可以记录所有系统调用，但开销很高。基于eBPF的工具，如`bpftrace`，是用于威胁狩猎的灵活、低开销系统调用追踪的现代解决方案。

对API挂钩等高级遥测技术的需求，是攻击者将其技术转移到内存中以规避基于文件的检测的直接结果。当EDR在检测磁盘上的恶意文件方面变得越来越有效时，攻击者便开始采用"无文件"技术，即恶意载荷从不写入磁盘，而是直接从一个进程的内存注入到另一个进程中。这个注入过程依赖于一系列标准的Windows API调用：打开目标进程的句柄、在其内部申请内存（VirtualAllocEx）、将载荷写入该内存（WriteProcessMemory），然后执行它（CreateRemoteThread）。为了检测这种行为，EDR别无选择，只能将其监控从文件系统"向上移动"到API层面，通过挂钩这些特定函数来观察这种行为。这又引发了下一阶段的攻防竞赛：攻击者开发出绕过API挂钩的技术（例如，直接系统调用），迫使防御者将其检测能力进一步下沉到内核。

此外，标准的操作系统日志记录了系统的行为，但常常忽略了用户交互式键入的命令。一个攻击者获得了对Linux服务器的低权限交互式访问权限后，可能会花费数小时键入各种枚举命令（whoami、uname -a、ps aux、cat /etc/passwd）来了解系统。这些命令本身大多是良性的，可能不会触发auditd的警报，而`.bash_history`文件在用户控制之下，可以被清除或禁用。这就导致安全团队对攻击者的侦察阶段一无所知。实施一个防篡改的、集中的命令历史日志可弥补这一可见性差距，它提供了攻击者交互式会话的完整、实时的记录，这在取证上是无价的。这意味着EDR遥测不仅要覆盖程序化执行，还必须覆盖交互式用户行为，以提供完整的攻击图景。

## 第四部分：数据采集策略 - 实施与优化

本部分将提供构建和管理EDR代理及其数据管道的实用指南，重点关注前述分析中讨论的各种权衡。

### 代理架构

*   **讨论内核模式与用户模式代理的优缺点**。
    *   **内核模式**：提供最高级别的可见性，并且更难被篡改。例如Windows的文件系统微筛选器驱动和Linux的内核模块/eBPF。但开发风险更高，因为一个bug可能导致整个操作系统崩溃。
    *   **用户模式**：开发更安全、更容易。使用API挂钩等技术。但更容易被高级攻击者绕过。
    *   **混合方法**：大多数现代EDR采用混合模型，拥有一个特权的内核组件用于强大的数据收集，以及一个用户空间代理用于管理、通信和收集不太关键的数据。

### 性能优化与过滤

*   **过滤的必要性**：重申由于性能和成本原因，收集所有数据是不可行的。
*   **代理端过滤**：最有效的方法。使用配置文件（例如，Sysmon的XML配置）在源头排除已知的、高容量的良性事件，在它们被处理或传输之前就丢弃。
*   **摄取端过滤**：在数据到达中央平台时进行过滤。对端点来说效率较低，但提供了在不重新部署代理的情况下更改规则的灵活性。

### 配置管理

*   **讨论一个用于管理代理配置的集中式系统的重要性**，该系统允许管理员调整过滤规则、启用/禁用数据源，并在整个设备群中部署更新。

## 第五部分：结论 - 将遥测数据综合为可操作的情报

本报告详细阐述了构建一个全面的EDR遥测策略所需的数据类别、采集机制和战略考量。成功的EDR并非建立在数据的绝对数量之上，而是建立在多样化、上下文丰富且紧密关联的数据基础之上。

我们从进程活动这一基石开始，强调了完整命令行和进程GUID等上下文数据对于准确归因和重建执行链的无可替代的重要性。接着，我们探讨了文件系统、网络和身份验证日志，揭示了如何通过监控这些领域的活动来检测从恶意软件植入到横向移动的各种攻击行为。对于无文件攻击和内核级威胁等高级技术，我们详细说明了必须采集动态代码加载、脚本块内容和驱动加载等高级遥测数据。

贯穿整个设计过程的核心原则是与MITRE ATT&CK®框架对齐，确保所有采集的数据点都有明确的、以威胁为导向的目的。这种方法不仅保证了可见性的全面性，也为检测规则的开发、威胁狩猎的假设以及防御能力的评估提供了坚实的依据。

最终，数据采集只是第一步。最终目标是将这些高保真度的遥测数据输入一个强大的分析引擎——无论是基于规则、基于机器学习，还是由人类分析师驱动——该引擎能够跨越时间和端点关联事件，从而在海量数据中识别出复杂攻击链的微弱信号。随着安全边界的日益模糊，这种丰富的端点遥测数据与来自网络、云和电子邮件等其他安全控制的数据相融合，即向XDR的演进，将是提供真正全面的组织安全态势感知的必然方向。